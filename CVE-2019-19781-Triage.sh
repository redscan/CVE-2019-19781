#!/usr/bin/env bash
#Redscan - CVE-2019-19781 - Attack Detection Triage

loggingDir=DFIRLogs
mkdir -p "$loggingDir"
date +%Y-%m-%d_%H:%M:%S > $loggingDir/time.txt
history > $loggingDir/history.txt
cat /var/log/bash.log | grep -Eio "shell_command=.*$" | sort | uniq -c | sort -n && zcat /var/log/bash*.gz | grep -Eio "shell_command=.*$" | sort | uniq -c | sort -n > $loggingDir/bashlog.txt
find / -name "*.xml" -exec ls -haltr {} \; | sed 's/ */ /g' | sort -k 8 > $loggingDir/xml.txt
cat /var/log/* | grep -Ei "vpns|\.pl " && zcat /var/log/*.gz | grep -Ei "vpns|\.pl " > $loggingDir/vpnsHistory.txt
find / -name "*.xml" -newermt "2020-01-10" && find / -name "*.pl" -newermt "2020-01-10" && find / -name "*.py" -newermt "2020-01-10" > $loggingDir/recentlywritten.txt
cat /var/log/cron | sed 's/ */ /g' | cut -d" " -f 10 | sort | uniq -c && zcat /var/log/cron*gz | sed 's/ */ /g' | cut -d" " -f 10 | sort | uniq -c > $logginDir/crontab.txt
find / -name "*.pl" -exec ls -haltr {} \; | grep -iv "local\/lib" | sed 's/ */ /g' | sort -k 8 > $loggingDir>plFiles.txt
lsof -RPni && lsof -PnP > $loggingDir/suspiciousFiles.txt
ps auxd | grep nobody > $loggingDir/suspiciousProcess.txt
zgrep -Ei "newbm.pl |rmbm.pl |picktheme.pl " /var/log/*.gz > $loggingDir/suspiciousScripts.txt
find /netscaler -newermt "2020-01-10" -type f -print0 | xargs -0 /bin/ls -ltr > $loggingDir/recentlywrittenNetscaler.txt
cat /var/log/cron | sed 's/  */ /g' | cut -d" " -f 10 | sort | uniq -c && zcat /var/log/cron*gz | sed 's/  */ /g' | cut -d" " -f 10 | sort | uniq -c /6 >  $loggingDir/cronTab.txt
grep -Hin '.pl HTTP/1.1" 200 143' /var/log/*  | grep POST > $loggingDir/POST.txt
grep -HiEn 'GET.*\.xml HTTP/1\.1\" 200' /var/log/* -B 1 > $loggingDir/GET.txt
grep -Hirn --include *.xml "template\.new.*block.*print" /var/tmp/netscaler/portal/templates/ > $loggingDir/suspiciousXml.txt
grep -Hirn --include *.xml "template\.new.*block.*print" /netscaler/portal/templates/ >> $loggingDir/suspiciousXml.txt
sockstat -c -4 | awk '{ if (substr($7,1,8) != "127.0.0.") print $0}' > $loggingDir/sockstat.txt
tar -czf - logs/* > Redscan_Triage_Logs.tar.gz